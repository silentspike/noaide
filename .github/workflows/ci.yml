name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  # ──────────────────────────────────────────────────────────────
  # Path Filter: Determines which jobs need to run
  # ──────────────────────────────────────────────────────────────
  paths-filter:
    name: Detect Changed Paths
    runs-on: ubuntu-latest
    outputs:
      docs-only: ${{ steps.filter.outputs.docs-only }}
      frontend: ${{ steps.filter.outputs.frontend }}
      rust: ${{ steps.filter.outputs.rust }}
      ci: ${{ steps.filter.outputs.ci }}
      has-cargo: ${{ steps.manifests.outputs.has-cargo }}
      has-frontend: ${{ steps.manifests.outputs.has-frontend }}
    steps:
      - uses: actions/checkout@v6

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docs-only:
              - '*.md'
              - 'docs/**'
              - 'LICENSE'
            frontend:
              - 'frontend/**'
            rust:
              - 'src/**'
              - 'server/**'
              - 'crates/**'
              - 'xtask/**'
              - 'Cargo.*'
              - 'wasm/**'
              - 'schemas/**'
            ci:
              - '.github/**'

      - name: Check for project manifests
        id: manifests
        run: |
          if [ -f "Cargo.toml" ]; then
            echo "has-cargo=true" >> "$GITHUB_OUTPUT"
          else
            echo "has-cargo=false" >> "$GITHUB_OUTPUT"
          fi
          if [ -f "frontend/package.json" ]; then
            echo "has-frontend=true" >> "$GITHUB_OUTPUT"
          else
            echo "has-frontend=false" >> "$GITHUB_OUTPUT"
          fi

  # ──────────────────────────────────────────────────────────────
  # Language Gate: Always runs (checks GitHub-facing files)
  # ──────────────────────────────────────────────────────────────
  language-check:
    name: Language Gate (English Only)
    runs-on: ubuntu-latest
    needs: paths-filter
    steps:
      - uses: actions/checkout@v6

      - name: Check for German content in GitHub-facing files
        run: |
          echo "Checking GitHub-facing files for German language content..."
          GERMAN_PATTERNS='(Akzeptanzkriterien|Beschreibung|Abhaengigkeiten|Aenderung|Ergebnis|Pflicht|Pruefung|Ausfuehren|Loeschen|Erstellen|Hinzufuegen|Zusammenfassung|Fehlgeschlagen|Voraussetzungen|Begruendung|Unterstuetzung)'
          ERRORS=0
          for file in README.md CONTRIBUTING.md SECURITY.md CHANGELOG.md TESTING.md CODE_OF_CONDUCT.md \
                      .github/workflows/*.yml .github/ISSUE_TEMPLATE/*.yml .github/PULL_REQUEST_TEMPLATE.md \
                      .github/dependabot.yml .github/CODEOWNERS llms.txt; do
            if [ -f "$file" ]; then
              # Skip lines that define the pattern itself (avoids false positive)
              if grep -viP "GERMAN_PATTERNS=" "$file" | grep -qiP "$GERMAN_PATTERNS"; then
                echo "::error file=$file::German content detected in $file"
                grep -viP "GERMAN_PATTERNS=" "$file" | grep -niP "$GERMAN_PATTERNS" || true
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Found German content in $ERRORS file(s). All GitHub content must be in English."
            exit 1
          fi
          echo "Language check passed."

      - name: Check for internal references leak
        run: |
          echo "Checking for internal references that should not be public..."
          INTERNAL_PATTERNS='(IMPL-PLAN\.md|\.audit/|\.claude/rules|/home/[a-z]|/work/noaide|cargo remote|10\.0\.0\.[0-9]+|192\.168\.[0-9]+\.[0-9]+|root@[0-9]+\.[0-9]+)'
          ERRORS=0
          for file in README.md CONTRIBUTING.md SECURITY.md CHANGELOG.md TESTING.md \
                      CODE_OF_CONDUCT.md llms.txt scripts/*.sh \
                      .github/workflows/*.yml .github/ISSUE_TEMPLATE/*.yml; do
            if [ -f "$file" ]; then
              # Skip lines that define the pattern itself (avoids false positive)
              if grep -vP "INTERNAL_PATTERNS=" "$file" | grep -qP "$INTERNAL_PATTERNS"; then
                echo "::error file=$file::Internal reference leaked in $file"
                grep -vP "INTERNAL_PATTERNS=" "$file" | grep -nP "$INTERNAL_PATTERNS" || true
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Found internal references in $ERRORS file(s). Replace with placeholders."
            exit 1
          fi
          echo "Internal reference check passed."

      - name: Check for hidden Unicode characters
        run: |
          if grep -rP '[\x{200B}-\x{200F}\x{202A}-\x{202E}\x{2066}-\x{2069}]' \
            --include='*.rs' --include='*.ts' --include='*.tsx' --include='*.js' \
            --include='*.yml' --include='*.yaml' --include='*.md' --include='*.toml' \
            --include='*.json' --include='*.css' --include='*.html' .; then
            echo "::error::Hidden Unicode/Bidi characters found (CVE-2021-42574)!"
            exit 1
          fi
          echo "Unicode check passed."

  # ──────────────────────────────────────────────────────────────
  # Lint (Rust): Runs on rust, wasm, or CI changes
  # ──────────────────────────────────────────────────────────────
  lint-rust:
    name: Lint (Rust)
    runs-on: ubuntu-latest
    needs: paths-filter
    if: (needs.paths-filter.outputs.rust == 'true' || needs.paths-filter.outputs.ci == 'true') && needs.paths-filter.outputs.has-cargo == 'true'
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # ──────────────────────────────────────────────────────────────
  # Lint (Frontend): Runs on frontend or CI changes
  # ──────────────────────────────────────────────────────────────
  lint-frontend:
    name: Lint (Frontend)
    runs-on: ubuntu-latest
    needs: paths-filter
    if: (needs.paths-filter.outputs.frontend == 'true' || needs.paths-filter.outputs.ci == 'true') && needs.paths-filter.outputs.has-frontend == 'true'
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: cd frontend && npm ci

      - name: ESLint
        run: cd frontend && npm run lint

      - name: TypeScript type check
        run: cd frontend && npm run typecheck

  # ──────────────────────────────────────────────────────────────
  # Test (Rust): Runs on rust, wasm, or CI changes
  # ──────────────────────────────────────────────────────────────
  test-rust:
    name: Test (Rust)
    runs-on: ubuntu-latest
    needs: [paths-filter, lint-rust]
    if: (needs.paths-filter.outputs.rust == 'true' || needs.paths-filter.outputs.ci == 'true') && needs.paths-filter.outputs.has-cargo == 'true'
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Unit and integration tests
        run: cargo test --all-features

  # ──────────────────────────────────────────────────────────────
  # Test (Frontend): Runs on frontend or CI changes
  # ──────────────────────────────────────────────────────────────
  test-frontend:
    name: Test (Frontend)
    runs-on: ubuntu-latest
    needs: [paths-filter, lint-frontend]
    if: (needs.paths-filter.outputs.frontend == 'true' || needs.paths-filter.outputs.ci == 'true') && needs.paths-filter.outputs.has-frontend == 'true'
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: cd frontend && npm ci

      - name: Run tests
        run: cd frontend && npm test -- --coverage

  # ──────────────────────────────────────────────────────────────
  # Security: Gitleaks + cargo-audit + npm audit + Semgrep
  # ──────────────────────────────────────────────────────────────
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: paths-filter
    if: (needs.paths-filter.outputs.rust == 'true' || needs.paths-filter.outputs.frontend == 'true' || needs.paths-filter.outputs.ci == 'true') && (needs.paths-filter.outputs.has-cargo == 'true' || needs.paths-filter.outputs.has-frontend == 'true')
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Gitleaks secret scan
        run: |
          GITLEAKS_VERSION="8.24.3"
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" | tar xz
          ./gitleaks detect --source=. --verbose --redact

      - uses: dtolnay/rust-toolchain@stable
        if: needs.paths-filter.outputs.has-cargo == 'true'

      - name: Install cargo-audit
        if: needs.paths-filter.outputs.has-cargo == 'true'
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: Cargo audit
        if: needs.paths-filter.outputs.has-cargo == 'true'
        run: cargo audit --ignore RUSTSEC-2023-0071

      - uses: actions/setup-node@v6
        if: needs.paths-filter.outputs.has-frontend == 'true'
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: npm audit
        if: needs.paths-filter.outputs.has-frontend == 'true'
        run: cd frontend && npm ci && npm audit --audit-level=high --omit=dev

      - name: Semgrep SAST scan
        uses: semgrep/semgrep-action@v1
        with:
          config: auto

  # ──────────────────────────────────────────────────────────────
  # Build: FlatBuffers → Rust → WASM → Frontend
  # ──────────────────────────────────────────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [paths-filter, test-rust, test-frontend, security, language-check]
    if: needs.paths-filter.outputs.has-cargo == 'true' && !(needs.paths-filter.outputs.docs-only == 'true' && needs.paths-filter.outputs.rust == 'false' && needs.paths-filter.outputs.frontend == 'false' && needs.paths-filter.outputs.ci == 'false')
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Install FlatBuffers compiler
        run: |
          FLATC_VERSION="25.2.10"
          curl -sSfL "https://github.com/google/flatbuffers/releases/download/v${FLATC_VERSION}/Linux.flatc.binary.g++-13.zip" -o flatc.zip
          unzip -o flatc.zip flatc
          chmod +x flatc
          sudo mv flatc /usr/local/bin/
          flatc --version

      - name: Generate FlatBuffers
        run: |
          if [ -f "schemas/messages.fbs" ]; then
            mkdir -p generated
            flatc --rust --ts -o generated/ schemas/messages.fbs
          else
            echo "No FlatBuffers schema found, skipping generation"
          fi

      - name: Build release binary
        run: cargo build --release

      - name: Install wasm-pack
        uses: taiki-e/install-action@v2
        with:
          tool: wasm-pack

      - name: Build WASM modules
        run: |
          for mod in jsonl-parser markdown compress; do
            wasm-pack build wasm/$mod --target web --out-dir ../../frontend/src/wasm/$mod
          done

      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: cd frontend && npm ci && npm run build

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: noaide-${{ github.sha }}
          path: |
            target/release/noaide-server
            frontend/dist/

  # ──────────────────────────────────────────────────────────────
  # System Artifact: Verify the built binary
  # ──────────────────────────────────────────────────────────────
  system-artifact:
    name: System Artifact Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v6

      - uses: actions/download-artifact@v7
        with:
          name: noaide-${{ github.sha }}

      - name: Verify binary
        run: |
          chmod +x target/release/noaide-server
          ./target/release/noaide-server --version || echo "Version check complete"

  # ──────────────────────────────────────────────────────────────
  # Integration Tests: Main Gate (only on push to main)
  # ──────────────────────────────────────────────────────────────
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: build
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Integration tests
        run: cargo test --test integration

  # ──────────────────────────────────────────────────────────────
  # E2E Smoke Tests: Main Gate (only on push to main)
  # ──────────────────────────────────────────────────────────────
  e2e-smoke:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: build
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: cd frontend && npm ci

      - name: Install Playwright browsers
        run: cd frontend && npx playwright install chromium --with-deps

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Run E2E smoke tests
        run: cd frontend && npm run e2e

  # ──────────────────────────────────────────────────────────────
  # CI Gate: Single required check that always runs.
  # Conditional jobs (lint, test, build) may skip on docs-only
  # changes. This job aggregates their results so branch
  # protection only needs one required check: "CI Gate".
  # ──────────────────────────────────────────────────────────────
  ci-gate:
    name: CI Gate
    runs-on: ubuntu-latest
    if: always()
    needs:
      - paths-filter
      - language-check
      - lint-rust
      - lint-frontend
      - test-rust
      - test-frontend
      - security
      - build
      - system-artifact
    steps:
      - name: Check job results
        run: |
          echo "paths-filter: ${{ needs.paths-filter.result }}"
          echo "language-check: ${{ needs.language-check.result }}"
          echo "lint-rust: ${{ needs.lint-rust.result }}"
          echo "lint-frontend: ${{ needs.lint-frontend.result }}"
          echo "test-rust: ${{ needs.test-rust.result }}"
          echo "test-frontend: ${{ needs.test-frontend.result }}"
          echo "security: ${{ needs.security.result }}"
          echo "build: ${{ needs.build.result }}"
          echo "system-artifact: ${{ needs.system-artifact.result }}"

          # Fail if any job failed (skipped is OK for conditional jobs)
          if [[ "${{ needs.paths-filter.result }}" == "failure" ]] ||
             [[ "${{ needs.language-check.result }}" == "failure" ]] ||
             [[ "${{ needs.lint-rust.result }}" == "failure" ]] ||
             [[ "${{ needs.lint-frontend.result }}" == "failure" ]] ||
             [[ "${{ needs.test-rust.result }}" == "failure" ]] ||
             [[ "${{ needs.test-frontend.result }}" == "failure" ]] ||
             [[ "${{ needs.security.result }}" == "failure" ]] ||
             [[ "${{ needs.build.result }}" == "failure" ]] ||
             [[ "${{ needs.system-artifact.result }}" == "failure" ]]; then
            echo "::error::One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs passed or were skipped (docs-only)"
