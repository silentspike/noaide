name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  # ──────────────────────────────────────────────────────────────
  # Path Filter: Determines which jobs need to run
  # ──────────────────────────────────────────────────────────────
  paths-filter:
    name: Detect Changed Paths
    runs-on: [self-hosted, linux]
    outputs:
      docs-only: ${{ steps.filter.outputs.docs-only }}
      frontend: ${{ steps.filter.outputs.frontend }}
      rust: ${{ steps.filter.outputs.rust }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docs-only:
              - '*.md'
              - 'docs/**'
              - 'LICENSE'
            frontend:
              - 'frontend/**'
            rust:
              - 'src/**'
              - 'Cargo.*'
              - 'wasm/**'
              - 'schemas/**'
            ci:
              - '.github/**'

  # ──────────────────────────────────────────────────────────────
  # Language Gate: Always runs (checks GitHub-facing files)
  # ──────────────────────────────────────────────────────────────
  language-check:
    name: Language Gate (English Only)
    runs-on: [self-hosted, linux]
    needs: paths-filter
    steps:
      - uses: actions/checkout@v4

      - name: Check for German content in GitHub-facing files
        run: |
          echo "Checking GitHub-facing files for German language content..."
          GERMAN_PATTERNS='(Akzeptanzkriterien|Beschreibung|Abhaengigkeiten|Aenderung|Ergebnis|Pflicht|Pruefung|Ausfuehren|Loeschen|Erstellen|Hinzufuegen|Zusammenfassung|Fehlgeschlagen|Voraussetzungen|Begruendung|Unterstuetzung)'
          ERRORS=0
          for file in README.md CONTRIBUTING.md SECURITY.md CHANGELOG.md TESTING.md CODE_OF_CONDUCT.md \
                      .github/workflows/*.yml .github/ISSUE_TEMPLATE/*.yml .github/PULL_REQUEST_TEMPLATE.md \
                      .github/dependabot.yml .github/CODEOWNERS llms.txt; do
            if [ -f "$file" ]; then
              if grep -qiP "$GERMAN_PATTERNS" "$file"; then
                echo "::error file=$file::German content detected in $file"
                grep -niP "$GERMAN_PATTERNS" "$file" || true
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Found German content in $ERRORS file(s). All GitHub content must be in English."
            exit 1
          fi
          echo "Language check passed."

      - name: Check for internal references leak
        run: |
          echo "Checking for internal references that should not be public..."
          INTERNAL_PATTERNS='(IMPL-PLAN\.md|\.audit/|\.claude/rules|/home/[a-z]|/work/noaide|cargo remote|10\.0\.0\.[0-9]+|192\.168\.[0-9]+\.[0-9]+|root@[0-9]+\.[0-9]+)'
          ERRORS=0
          for file in README.md CONTRIBUTING.md SECURITY.md CHANGELOG.md TESTING.md \
                      CODE_OF_CONDUCT.md llms.txt scripts/*.sh \
                      .github/workflows/*.yml .github/ISSUE_TEMPLATE/*.yml; do
            if [ -f "$file" ]; then
              if grep -qP "$INTERNAL_PATTERNS" "$file"; then
                echo "::error file=$file::Internal reference leaked in $file"
                grep -nP "$INTERNAL_PATTERNS" "$file" || true
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Found internal references in $ERRORS file(s). Replace with placeholders."
            exit 1
          fi
          echo "Internal reference check passed."

      - name: Check for hidden Unicode characters
        run: |
          if grep -rP '[\x{200B}-\x{200F}\x{202A}-\x{202E}\x{2066}-\x{2069}]' \
            --include='*.rs' --include='*.ts' --include='*.tsx' --include='*.js' \
            --include='*.yml' --include='*.yaml' --include='*.md' --include='*.toml' \
            --include='*.json' --include='*.css' --include='*.html' .; then
            echo "::error::Hidden Unicode/Bidi characters found (CVE-2021-42574)!"
            exit 1
          fi
          echo "Unicode check passed."

  # ──────────────────────────────────────────────────────────────
  # Lint (Rust): Runs on rust, wasm, or CI changes
  # ──────────────────────────────────────────────────────────────
  lint-rust:
    name: Lint (Rust)
    runs-on: [self-hosted, linux]
    needs: paths-filter
    if: >-
      needs.paths-filter.outputs.rust == 'true' ||
      needs.paths-filter.outputs.ci == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # ──────────────────────────────────────────────────────────────
  # Lint (Frontend): Runs on frontend or CI changes
  # ──────────────────────────────────────────────────────────────
  lint-frontend:
    name: Lint (Frontend)
    runs-on: [self-hosted, linux]
    needs: paths-filter
    if: >-
      needs.paths-filter.outputs.frontend == 'true' ||
      needs.paths-filter.outputs.ci == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: cd frontend && npm ci

      - name: ESLint
        run: cd frontend && npm run lint

  # ──────────────────────────────────────────────────────────────
  # Test (Rust): Runs on rust, wasm, or CI changes
  # ──────────────────────────────────────────────────────────────
  test-rust:
    name: Test (Rust)
    runs-on: [self-hosted, linux]
    needs: [paths-filter, lint-rust]
    if: >-
      needs.paths-filter.outputs.rust == 'true' ||
      needs.paths-filter.outputs.ci == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Unit and integration tests
        run: cargo test --all-features

  # ──────────────────────────────────────────────────────────────
  # Test (Frontend): Runs on frontend or CI changes
  # ──────────────────────────────────────────────────────────────
  test-frontend:
    name: Test (Frontend)
    runs-on: [self-hosted, linux]
    needs: [paths-filter, lint-frontend]
    if: >-
      needs.paths-filter.outputs.frontend == 'true' ||
      needs.paths-filter.outputs.ci == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: cd frontend && npm ci

      - name: Run tests
        run: cd frontend && npm test -- --coverage

  # ──────────────────────────────────────────────────────────────
  # Security: Gitleaks + cargo-audit + npm audit + Semgrep
  # ──────────────────────────────────────────────────────────────
  security:
    name: Security Audit
    runs-on: [self-hosted, linux]
    needs: paths-filter
    if: >-
      needs.paths-filter.outputs.rust == 'true' ||
      needs.paths-filter.outputs.frontend == 'true' ||
      needs.paths-filter.outputs.ci == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks secret scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: Cargo audit
        run: cargo audit

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: npm audit
        run: cd frontend && npm ci && npm audit --audit-level=high

      - name: Semgrep SAST scan
        uses: semgrep/semgrep-action@v1
        with:
          config: auto

  # ──────────────────────────────────────────────────────────────
  # Build: FlatBuffers → Rust → WASM → Frontend
  # ──────────────────────────────────────────────────────────────
  build:
    name: Build
    runs-on: [self-hosted, linux]
    needs: [paths-filter, test-rust, test-frontend, security, language-check]
    if: >-
      !(
        needs.paths-filter.outputs.docs-only == 'true' &&
        needs.paths-filter.outputs.rust == 'false' &&
        needs.paths-filter.outputs.frontend == 'false' &&
        needs.paths-filter.outputs.ci == 'false'
      )
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Generate FlatBuffers
        run: flatc --rust --ts -o generated/ schemas/messages.fbs

      - name: Build release binary
        run: cargo build --release

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Build WASM modules
        run: |
          for mod in jsonl-parser markdown compress; do
            wasm-pack build wasm/$mod --target web --out-dir ../../frontend/src/wasm/$mod
          done

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: cd frontend && npm ci && npm run build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: noaide-${{ github.sha }}
          path: |
            target/release/noaide-server
            frontend/dist/

  # ──────────────────────────────────────────────────────────────
  # System Artifact: Verify the built binary
  # ──────────────────────────────────────────────────────────────
  system-artifact:
    name: System Artifact Test
    runs-on: [self-hosted, linux]
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: noaide-${{ github.sha }}

      - name: Verify binary
        run: |
          chmod +x target/release/noaide-server
          ./target/release/noaide-server --version || echo "Version check complete"

  # ──────────────────────────────────────────────────────────────
  # Integration Tests: Main Gate (only on push to main)
  # ──────────────────────────────────────────────────────────────
  integration-test:
    name: Integration Tests
    runs-on: [self-hosted, linux]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Integration tests
        run: cargo test --test integration
